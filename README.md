# üìß Email Service - Microsservi√ßo de E-mails

Microsservi√ßo robusto para envio de e-mails com filas BullMQ, templates din√¢micos e fallback entre provedores.

## üöÄ Caracter√≠sticas

- **NestJS + TypeScript** - Framework moderno e tipado
- **Prisma + PostgreSQL** - ORM type-safe com banco relacional
- **BullMQ + Redis** - Filas ass√≠ncronas modernas com Redis Streams
- **Gmail + SendGrid** - Fallback autom√°tico entre provedores
- **Templates Handlebars** - Templates din√¢micos com helpers
- **Configura√ß√£o Din√¢mica** - Settings no banco de dados
- **Rate Limiting** - Prote√ß√£o contra spam
- **Logs completos** - Rastreamento de todos os envios

## üìã Pr√©-requisitos

- Node.js 18+
- PostgreSQL 12+
- Redis 6+
- Conta Gmail com senha de app
- SendGrid API Key (opcional)

## üõ†Ô∏è Instala√ß√£o

### 1. Clone e instale depend√™ncias

```bash
git clone <repository>
cd email-service
npm install
```

### 2. Configure vari√°veis de ambiente

```bash
cp .env.example .env
# Edite o arquivo .env com suas configura√ß√µes
```

### 3. Configure o banco de dados

```bash
# Gerar Prisma Client
npm run prisma:generate

# Executar migrations
npm run prisma:migrate

# Migrar configura√ß√µes do .env para o banco
npm run migrate:configs
```

### 4. Inicie os servi√ßos

```bash
# Desenvolvimento
npm run start:dev

# Produ√ß√£o
npm run build
npm run start:prod
```

## üê≥ Docker

```bash
# Subir todos os servi√ßos
docker-compose up -d

# Ver logs
docker-compose logs -f email-service
```

## üìñ Uso da API

### Enviar E-mail

```bash
POST /api/email/send
Content-Type: application/json

{
  "to": "user@example.com",
  "subject": "Bem-vindo!",
  "template": "welcome",
  "variables": {
    "name": "Jo√£o Silva",
    "code": "123456"
  },
  "priority": "high"
}
```

**Resposta:**

```json
{
  "status": "enqueued",
  "message": "E-mail adicionado √† fila de processamento",
  "data": {
    "logId": "cm2x...",
    "jobId": "123",
    "priority": "high",
    "estimatedDelay": "5-15 segundos"
  }
}
```

### Verificar Status

```bash
GET /api/email/status/{logId}
```

**Resposta:**

```json
{
  "status": "success",
  "data": {
    "id": "cm2x...",
    "to": "user@example.com",
    "subject": "Bem-vindo!",
    "status": "SENT",
    "provider": "gmail",
    "sentAt": "2025-01-15T10:30:00Z",
    "attempts": 1,
    "job": {
      "id": "123",
      "progress": 100,
      "finishedOn": 1642248600000
    }
  }
}
```

### Health Check

```bash
GET /api/email/health
```

**Resposta:**

```json
{
  "status": "healthy",
  "timestamp": "2025-01-15T10:30:00Z",
  "queue": {
    "waiting": 0,
    "active": 2,
    "completed": 145,
    "failed": 3,
    "total": 150
  }
}
```

## üìß Templates Dispon√≠veis

### welcome.html
Template de boas-vindas com c√≥digo de verifica√ß√£o.

**Vari√°veis:**
- `name` - Nome do usu√°rio
- `code` - C√≥digo de verifica√ß√£o
- `activationUrl` - URL de ativa√ß√£o (opcional)

### reset-password.html
Template para redefini√ß√£o de senha.

**Vari√°veis:**
- `name` - Nome do usu√°rio
- `resetUrl` - URL de redefini√ß√£o
- `expiryTime` - Tempo de expira√ß√£o em minutos

### Helpers Dispon√≠veis

```handlebars
{{uppercase name}}          <!-- JO√ÉO SILVA -->
{{lowercase email}}          <!-- joao@email.com -->
{{formatDate date 'short'}}  <!-- 15/01/2025 -->
{{currency 99.90}}          <!-- R$ 99,90 -->
{{#ifEquals status 'active'}}Ativo{{/ifEquals}}
```

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

```env
# Database
DATABASE_URL="postgresql://user:pass@localhost:5432/email_service"

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# Gmail
GMAIL_USER=seu-email@gmail.com
GMAIL_PASS=sua-senha-de-app

# SendGrid
SENDGRID_API_KEY=SG.xxxxx

# Seguran√ßa
ALLOWED_IPS=127.0.0.1,::1,192.168.1.100
RATE_LIMIT_TTL=60
RATE_LIMIT_REQUESTS=10
```

### Prioridades de E-mail

- **CRITICAL** - Enviado imediatamente
- **HIGH** - Delay de 5 segundos
- **NORMAL** - Delay de 15 segundos (padr√£o)
- **LOW** - Delay de 30 segundos

## üìä Monitoramento e Administra√ß√£o

### APIs de Configura√ß√£o
```bash
# Configura√ß√µes por categoria
GET /api/admin/config/category/email
GET /api/admin/config/category/security

# Atualizar configura√ß√£o
PUT /api/admin/config/RATE_LIMIT_REQUESTS
{
  "value": 20,
  "changedBy": "admin",
  "reason": "Aumentar limite"
}

# Gerenciar IPs permitidos
GET /api/admin/config/allowed-ips
POST /api/admin/config/allowed-ips
DELETE /api/admin/config/allowed-ips/192.168.1.100
```

### Gerenciamento de Filas BullMQ
```bash
# Status da fila
GET /api/admin/queue/status

# Estat√≠sticas detalhadas
GET /api/admin/queue/stats

# Pausar/retomar fila
POST /api/admin/queue/pause
POST /api/admin/queue/resume

# Limpar jobs antigos
DELETE /api/admin/queue/clean?grace=3600000&status=completed

# Reprocessar jobs falhados
POST /api/admin/queue/retry-failed?limit=10
```

### Templates no Banco de Dados
```bash
# Listar templates
GET /api/admin/templates

# Criar template
POST /api/admin/templates
{
  "name": "invoice",
  "subject": "Fatura #{{number}}",
  "content": "<h1>Sua fatura</h1>...",
  "description": "Template de fatura"
}

# Preview de template
POST /api/admin/templates/invoice/preview
{
  "number": "12345",
  "amount": 99.90,
  "customer": { "name": "Jo√£o" }
}
```

### Dashboards
- **API Health**: `http://localhost:3000/api/metrics/health`
- **Bull Board**: `http://localhost:3000/api/admin/queues`
- **Prisma Studio**: `npm run prisma:studio`

## üéØ **Funcionalidades Avan√ßadas BullMQ**

### ‚úÖ **Email Flows (Sequ√™ncias Automatizadas)**
```bash
# Onboarding completo para novos usu√°rios
POST /api/email/flows/onboarding
{
  "userId": "user123",
  "userEmail": "user@example.com",
  "userData": {
    "name": "Jo√£o Silva",
    "plan": "premium"
  }
}

# Recupera√ß√£o de senha com alerta
POST /api/email/flows/password-recovery
{
  "userId": "user123",
  "userEmail": "user@example.com",
  "resetToken": "abc123",
  "userData": { "name": "Jo√£o" }
}

# Campanha de marketing personalizada
POST /api/email/flows/marketing-campaign
{
  "campaignId": "summer2025",
  "recipients": [
    {
      "userId": "user1",
      "email": "user1@example.com",
      "data": { "name": "Ana", "segment": "premium" }
    }
  ],
  "campaignData": {
    "subject": "Oferta especial de ver√£o!",
    "template": "summer-campaign"
  }
}
```

### ‚úÖ **Monitoramento de Performance**
```bash
# M√©tricas em tempo real
GET /api/metrics/performance?period=1h

# Hist√≥rico de m√©tricas
GET /api/metrics/performance/history?hours=24

# Alertas ativos
GET /api/metrics/performance/alerts

# Benchmark de performance
POST /api/metrics/performance/benchmark
```

### ‚úÖ **Gerenciamento Avan√ßado de Filas**
```bash
# Pausar fila durante manuten√ß√£o
POST /api/admin/queue/pause

# Retomar processamento
POST /api/admin/queue/resume

# Limpeza inteligente
DELETE /api/admin/queue/clean?grace=3600000&status=completed

# Reprocessar falhas em lote
POST /api/admin/queue/retry-failed?limit=100

# Estat√≠sticas detalhadas
GET /api/admin/queue/stats
```

## üìä **Dashboard de M√©tricas em Tempo Real**

### **Performance Metrics Response:**
```json
{
  "timestamp": "2025-01-20T10:30:00Z",
  "period": "1h",
  "email": {
    "totalSent": 1250,
    "totalFailed": 25,
    "averageProcessingTime": 2500,
    "throughputPerSecond": 0.35,
    "successRate": 98.04,
    "providerStats": {
      "gmail": { "sent": 800, "failed": 15, "avgTime": 2200 },
      "sendgrid": { "sent": 450, "failed": 10, "avgTime": 2800 }
    }
  },
  "queue": {
    "waiting": 45,
    "active": 8,
    "completed": 1200,
    "failed": 25,
    "delayed": 12,
    "throughput": 0.35,
    "averageWaitTime": 1500
  },
  "system": {
    "memoryUsage": {
      "rss": 45123456,
      "heapUsed": 23456789,
      "heapTotal": 35000000
    },
    "uptime": 86400,
    "redisMemory": "128MB",
    "redisConnections": 12
  },
  "alerts": [
    {
      "level": "warning",
      "message": "Fila com muitos jobs aguardando: 45",
      "metric": "queue.waiting",
      "value": 45,
      "threshold": 30
    }
  ]
}
```

## üîÑ **Email Flows - Sequ√™ncias Inteligentes**

### **1. Flow de Onboarding:**
```
üìß Boas-vindas (imediato)
  ‚Üì 24 horas
üìß Tutorial completo  
  ‚Üì 3 dias
üìß Recursos em destaque
  ‚Üì 7 dias  
üìß Pedido de feedback
```

### **2. Flow de Recupera√ß√£o:**
```
üîê Link de reset (imediato)
  ‚Üì 1 minuto
üö® Alerta de seguran√ßa
```

### **3. Campanha Marketing:**
```
üéØ Email principal (delay aleat√≥rio)
  ‚Üì 3 dias (opcional)
üìà Follow-up personalizado
```

## üö® **Sistema de Alertas Inteligentes**

### **Alertas Autom√°ticos:**
- **Taxa de sucesso < 95%** ‚Üí Warning/Error
- **Fila > 1000 jobs** ‚Üí Warning/Error  
- **Tempo processamento > 30s** ‚Üí Warning/Error
- **Uso mem√≥ria > 80%** ‚Üí Warning/Error
- **Jobs falhados > 100** ‚Üí Warning/Error

### **Notifica√ß√µes:**
```bash
# Webhook autom√°tico para alertas cr√≠ticos
POST https://your-app.com/webhooks/email-alerts
{
  "level": "error",
  "message": "Taxa de sucesso cr√≠tica: 85%",
  "metric": "email.successRate", 
  "value": 85,
  "threshold": 90,
  "timestamp": "2025-01-20T10:30:00Z"
}
```

## üõ°Ô∏è **Seguran√ßa e Configura√ß√£o Din√¢mica**

### **Configura√ß√µes no Banco de Dados:**
```bash
# Todas as configura√ß√µes agora s√£o din√¢micas
GET /api/admin/config/category/security
PUT /api/admin/config/RATE_LIMIT_REQUESTS

# IPs permitidos com estat√≠sticas  
GET /api/admin/config/allowed-ips
POST /api/admin/config/allowed-ips
{
  "ipAddress": "192.168.1.100",
  "description": "Servidor de produ√ß√£o",
  "createdBy": "admin"
}

# Dom√≠nios bloqueados
GET /api/admin/config/blocked-domains
POST /api/admin/config/blocked-domains
{
  "domain": "spam-domain.com",
  "reason": "Hist√≥rico de spam",
  "blockedBy": "security-team"
}
```

### **Templates Versionados:**
```bash
# Templates no banco com hist√≥rico
GET /api/admin/templates
POST /api/admin/templates
{
  "name": "invoice-v2",
  "subject": "Fatura #{{number}} - {{company.name}}",
  "content": "<html>...</html>",
  "description": "Template de fatura atualizado"
}

# Preview em tempo real
POST /api/admin/templates/invoice-v2/preview
{
  "number": "12345",
  "amount": 150.00,
  "company": { "name": "ACME Corp" }
}
```

## üöÄ **Principais Vantagens da Migra√ß√£o**

### **Performance (BullMQ vs Bull):**
- **30-50% menos uso** de mem√≥ria Redis
- **2-3x melhor throughput** em alto volume  
- **Jobs com delay precisos** ao milissegundo
- **Rate limiting autom√°tico** por fila

### **Observabilidade:**
- **M√©tricas em tempo real** com hist√≥rico
- **Alertas inteligentes** autom√°ticos
- **Health checks detalhados** por componente
- **Benchmark de performance** integrado

### **Administra√ß√£o:**
- **Configura√ß√£o zero-downtime** via banco
- **Templates versionados** com aprova√ß√£o
- **Flows automatizados** para sequ√™ncias
- **Dashboard unificado** Bull Board

### **Seguran√ßa:**
- **IPs com rastreamento** de uso
- **Configura√ß√µes auditadas** com hist√≥rico
- **Webhooks assinados** com HMAC
- **Rate limiting din√¢mico** por contexto

## üìà **Casos de Uso Avan√ßados**

### **1. E-commerce:**
```bash
# Sequ√™ncia p√≥s-compra
POST /api/email/flows/onboarding
# ‚Üí Confirma√ß√£o ‚Üí Rastreamento ‚Üí Avalia√ß√£o ‚Üí Upsell
```

### **2. SaaS:**
```bash
# Trial to paid conversion
POST /api/email/flows/trial-conversion  
# ‚Üí Welcome ‚Üí Tutorial ‚Üí Feature highlight ‚Üí Upgrade offer
```

### **3. Campanhas:**
```bash
# Segmenta√ß√£o inteligente
POST /api/email/flows/marketing-campaign
# ‚Üí A/B test subjects ‚Üí Timing optimization ‚Üí Follow-up baseado em engagement
```

## üéØ **Roadmap e Pr√≥ximos Passos**

### **Implementado ‚úÖ:**
- ‚úÖ BullMQ com Redis Streams
- ‚úÖ Configura√ß√£o din√¢mica no banco
- ‚úÖ Templates versionados
- ‚úÖ Email flows automatizados  
- ‚úÖ Monitoramento avan√ßado
- ‚úÖ Alertas inteligentes
- ‚úÖ APIs de administra√ß√£o

### **Pr√≥ximas Features üîÑ:**
- üîÑ Interface web de administra√ß√£o
- üîÑ A/B testing de templates
- üîÑ Analytics de engagement
- üîÑ Integra√ß√£o com CRMs
- üîÑ Machine learning para otimiza√ß√£o

### **Opcional üí°:**
- üí° Multi-tenancy para SaaS
- üí° Plugin system para extens√µes
- üí° GraphQL API
- üí° Mobile push notifications

---

**üéâ O microsservi√ßo est√° production-ready com BullMQ e recursos enterprise!**